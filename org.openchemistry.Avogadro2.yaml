app-id: org.openchemistry.Avogadro2
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: 5.15-22.08
command: avogadro2
rename-desktop-file: avogadro2.desktop
finish-args:
  - --share=ipc
  # Broke in Wayland
  #- --socket=wayland
  - --socket=x11
  - --device=dri
  - --filesystem=home
  # Molequeue enjoy its life in the menu tray.
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  # Allow Avogadro to communicate with Molequeue.
  - --share=network
  - --talk-name=org.freedesktop.DBus
  - --talk-name=org.freedesktop.DBus.Proprieties
  - --system-talk-name=org.freedesktop.DBus
  - --system-talk-name=org.freedesktop.DBus.Proprieties
cleanup:
  - /include
  - /lib/cmake
  - /share/doc
  - '*.la'
  - '*.a'

modules:
  - shared-modules/glew/glew.json
  - shared-modules/glu/glu-9.json

  - name: OpenBLAS # dependency for Numpy
    no-autogen: true
    make-args:
      - DYNAMIC_ARCH=1
      - DYNAMIC_OLDER=1
      - FC=gfortran
      - TARGET=GENERIC
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.24.tar.gz
        sha256: ceadc5065da97bd92404cac7254da66cc6eb192679cf1002098688978d4d5132
        x-checker-data:
          type: anitya
          project-id: 2540
          url-template: https://github.com/xianyi/OpenBLAS/archive/v$version.tar.gz

  - python_deps.json
  # python3 flatpak-pip-generator tomli packaging pyproject_metadata numpy pybind11 -o python_deps && fb
  # - name: python3-numpy
  #   buildsystem: simple
  #   build-commands:
  #     - python3 -mpip install . --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
  #       --no-build-isolation
  #   sources:
  #     - type: archive
  #       url: https://files.pythonhosted.org/packages/55/b3/b13bce39ba82b7398c06d10446f5ffd5c07db39b09bd37370dc720c7951c/numpy-1.26.0.tar.gz
  #       sha256: f93fc78fe8bf15afe2b8d6b6499f1c73953169fad1e9a8dd086cdff3190e7fdf
  #       x-checker-data:
  #         type: pypi
  #         name: numpy

  - name: Eigen3
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
        sha256: b4c198460eba6f28d34894e3a5710998818515104d6e74e5cc331ce31e46e626
        x-checker-data:
          type: anitya
          project-id: 13751
          stable-only: true
          url-template: https://gitlab.com/libeigen/eigen/-/archive/$version/eigen-$version.tar.bz2
    cleanup:
      - '*'

  - name: hdf5
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DBUILD_TESTING:BOOL=OFF
      - -DHDF5_BUILD_EXAMPLES:BOOL=OFF
    cleanup:
      - /share/hdf5_examples
    sources:
      - type: archive
        url: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-1_14_2.tar.gz
        sha256: 83eaee3f9d1790bb4b29368bf1a648ece763097a4122c80a81076e8fb1e890e6
        x-checker-data:
          type: anitya
          project-id: 1303
          stable-only: true
          url-template: https://github.com/HDFGroup/hdf5/archive/refs/tags/hdf5-$version.tar.gz

  - name: libmsym
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX:PATH=/app
      - -DMSYM_BUILD_PYTHON:BOOL=ON
      - -DBUILD_SHARED_LIBS:BOOL=ON
    sources:
      - type: archive
        url: https://github.com/mcodev31/libmsym/archive/refs/tags/v0.2.3-paper.tar.gz
        sha256: 3741ebe163cf40696570d6b62e4834ca587d43dcac9de713994cc5e2960fb8fd
        x-checker-data:
          type: anitya
          project-id: 221475
          stable-only: true
          url-template: https://github.com/mcodev31/libmsym/archive/refs/tags/v$version.tar.gz

  # - name: pybind11
  #   buildsystem: simple
  #   build-commands:
  #     - python3 setup.py build
  #     - cmake -DPYBIND11_INSTALL=ON -DPYBIND11_TEST=OFF -DCMAKE_INSTALL_INCLUDEDIR:PATH=${FLATPAK_DEST}/include
  #       -DCMAKE_INSTALL_LIBDIR:PATH=${FLATPAK_DEST}/lib -DCMAKE_INSTALL_DATAROOTDIR:PATH=${FLATPAK_DEST}/share
  #       .
  #     - python3 setup.py install --prefix=${FLATPAK_DEST}
  #     - cmake --build .
  #     - cmake --install .
  #   sources:
  #     - type: archive
  #       url: https://github.com/pybind/pybind11/archive/v2.11.1.tar.gz
  #       sha256: d475978da0cdc2d43b73f30910786759d593a9d8ee05b1b6846d1eb16c6d2e0c
  #       x-checker-data:
  #         type: anitya
  #         project-id: 13384
  #         stable-only: true
  #         url-template: https://github.com/pybind/pybind11/archive/v$version.tar.gz

  - name: mmtf-cpp
    buildsystem: cmake
    config-opts:
      - -DBUILD_TESTS:BOOL=OFF
      - -Dmmtf_build_local:BOOL=ON
      - -Dmmtf_build_examples:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/rcsb/mmtf-cpp/archive/refs/tags/v1.1.0.tar.gz
        sha256: 021173bdc1814b1d0541c4426277d39df2b629af53151999b137e015418f76c0
        x-checker-data:
          type: anitya
          project-id: 221487
          stable-only: true
          url-template: https://github.com/rcsb/mmtf-cpp/archive/refs/tags/v$version.tar.gz

  - name: msgpack
    buildsystem: cmake
    config-opts:
      - -DCMAKE_INSTALL_PREFIX:PATH=/app
      - -DBUILD_SHARED_LIBS:BOOL=ON
      - -DMSGPACK_ENABLE_STATIC:BOOL=OFF
      - -DCMAKE_INSTALL_LIBDIR:PATH=lib
      - -DMSGPACK_BUILD_EXAMPLES:BOOL=OFF
      - -DMSGPACK_CXX11:BOOL=ON
    sources:
      - type: archive
        url: https://github.com/msgpack/msgpack-c/releases/download/cpp-3.3.0/msgpack-3.3.0.tar.gz
        sha256: 6e114d12a5ddb8cb11f669f83f32246e484a8addd0ce93f274996f1941c1f07b
        # x-checker-data:
        #   type: anitya
        #   project-id: 12278
        #   stable-only: true
        #   url-template: https://github.com/msgpack/msgpack-c/releases/download/cpp-$version/msgpack-$version.tar.gz

  - name: OpenBabel
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DENABLE_TESTS:BOOL=OFF
      - -DBUILD_GUI:BOOL=OFF
      - -DOPTIMIZE_NATIVE:BOOL=OFF
      - -DOB_USE_PREBUILT_BINARIES:BOOL=OFF
      - -DENABLE_VERSIONED_FORMATS:BOOL=OFF
      - -DWITH_JSON:BOOL=OFF
      - -DWITH_MAEPARSER:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/openbabel/openbabel/releases/download/openbabel-3-1-1/openbabel-3.1.1-source.tar.bz2
        sha256: a6ec8381d59ea32a4b241c8b1fbd799acb52be94ab64cdbd72506fb4e2270e68
        x-checker-data:
          type: anitya
          project-id: 2539
          stable-only: true
          url-template: https://github.com/openbabel/openbabel/releases/download/openbabel-3-1-1/openbabel-$version-source.tar.bz2

  - name: zeromq
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
    sources:
      - type: archive
        url: https://github.com/zeromq/libzmq/releases/download/v4.3.4/zeromq-4.3.4.tar.gz
        sha256: c593001a89f5a85dd2ddf564805deb860e02471171b3f204944857336295c3e5
        x-checker-data:
          type: anitya
          project-id: 16245
          stable-only: true
          url-template: https://github.com/zeromq/libzmq/releases/download/v$version/zeromq-$version.tar.gz

  - name: spglib
    buildsystem: simple
    ensure-writable:
      - /lib/python3/site-packages/easy-install.pth
    build-commands:
      - cmake -DCMAKE_INSTALL_PREFIX=${FLATPAK_DEST} -DCMAKE_INSTALL_INCLUDEDIR:PATH=${FLATPAK_DEST}/include
        -DCMAKE_INSTALL_LIBDIR:PATH=${FLATPAK_DEST}/lib .
      - cmake --build .
      - cmake --install .
      - cd python && python3 -mpip install . --no-index --find-links=file://${PWD}
        --prefix=${FLATPAK_DEST} --no-build-isolation
    sources:
      - type: archive
        url: https://github.com/spglib/spglib/archive/refs/tags/v2.0.0.tar.gz
        sha256: 426c4004e84fdb732d86aa5fcada5257ca8bc7a6915c06ced27565176c16ee96
        x-checker-data:
          type: anitya
          project-id: 14891
          stable-only: true
          url-template: https://github.com/spglib/spglib/archive/refs/tags/v$version.tar.gz

  - name: MoleQueue
    buildsystem: simple
    build-commands:
      - install -Dm0644 molequeue/app/icons/molequeue.png /app/share/icons/hicolor/32x32/apps/${FLATPAK_ID}.Molequeue.png
      - cmake -DENABLE_TESTING:BOOL=OFF -DBUILD_DOCUMENTATION:BOOL=OFF -DCMAKE_INSTALL_PREFIX:PATH=/app
        -Wno-dev .
      - cmake --build .
      - cmake --install .
      - install -Dm0644 ${FLATPAK_ID}.Molequeue.desktop ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.Molequeue.desktop
      - desktop-file-validate ${FLATPAK_DEST}/share/applications/${FLATPAK_ID}.Molequeue.desktop
    sources:
      - type: archive
        url: https://github.com/OpenChemistry/molequeue/releases/download/0.9.0/molequeue-0.9.0.tar.bz2
        sha256: 2825fa9645fca707796ad32967c307bec76dab4f6c305befeebeac8c7f7f2ef0
        x-checker-data:
          type: anitya
          project-id: 13839
          stable-only: true
          url-template: https://github.com/OpenChemistry/molequeue/releases/download/$version/molequeue-$version.tar.bz2
      - type: file
        path: org.openchemistry.Avogadro2.Molequeue.desktop

  #- name: protobuf
    #buildsystem: cmake
    #subdir: cmake
    #sources:
      #- type: archive
        #url: https://github.com/protocolbuffers/protobuf/releases/download/v3.15.6/protobuf-cpp-3.15.6.tar.gz
        #sha256: bbdfb7455431d7d58666e8a2996d14b236718ff238eecde10646581e4c87f168

  #- name: protocall-OpenChemistry
    #buildsystem: cmake
    #sources:
      #- type: git
        #url: https://github.com/OpenChemistry/protocall

    # Avogadrolibs does not build with VTK 9.0.1
    # https://github.com/OpenChemistry/avogadrolibs/issues/516
  - name: VTK
    buildsystem: cmake-ninja
    builddir: true
    build-options:
      cflags: -O2 -D_FORTIFY_SOURCE=2 -fstack-protector-strong -funwind-tables -fasynchronous-unwind-tables
        -fstack-clash-protection -flto -fno-fat-lto-objects
      cxxflags: -O2 -D_FORTIFY_SOURCE=2 -fstack-protector-strong -funwind-tables -fasynchronous-unwind-tables
        -fstack-clash-protection -flto -fno-fat-lto-objects
    config-opts:
      - -DBUILD_SHARED_LIBS=ON
      - -DOpenGL_GL_PREFERENCE=GLVND
      - -DBUILD_TESTING:BOOL=OFF
      - -DVTK_GROUP_ENABLE_Qt:BOOL=YES
      - -DVTK_BUILD_COMPILE_TOOLS_ONLY:BOOL=OFF
    sources:
      - type: archive
        url: https://www.vtk.org/files/release/9.2/VTK-9.2.0.rc1.tar.gz
        sha256: 3d219ae624d0ce6d72bb9bdbf5895d0eaa875ff3115a61d3c300b257ea7c0f7e

  - name: avogadrolibs
    buildsystem: cmake
    builddir: true
    subdir: avogadrolibs
    config-opts:
      - -DOpenGL_GL_PREFERENCE=GLVND
      - -DUSE_SYSTEM_GENXRDPATTERN:BOOL=ON
      - -DCMAKE_BUILD_TYPE:STRING=Release
      - -DENABLE_TRANSLATIONS:BOOL=ON
      - -DUSE_HDF5:BOOL=ON
      - -DUSE_PYTHON:BOOL=ON
      - -DUSE_QT:BOOL=ON
      - -DUSE_LIBMSYM:BOOL=ON
      - -DUSE_SPGLIB:BOOL=ON
      - -DUSE_MMTF:BOOL=ON
      - -DUSE_MOLEQUEUE:BOOL=ON
      - -DUSE_PROTOCALL:BOOL=OFF
      - -DUSE_VTK:BOOL=ON
      - -DBUILD_GPL_PLUGINS:BOOL=ON
      - -DBUILD_STATIC_PLUGINS:BOOL=ON
      - -Dlibmsym_DIR:PATH=${FLATPAK_DEST}/lib/cmake/libmsym
      - -Dpybind11_DIR:PATH=${FLATPAK_DEST}/lib/python3.8/site-packages/pybind11-2.6.2-py3.8.egg/pybind11/share/cmake/pybind11/
    sources:
      - type: git
        url: https://github.com/OpenChemistry/avogadrolibs
        tag: 1.97.0
        commit: 82938e4f5ce188a1e53300d263167bebe717f5b2
        dest: avogadrolibs
        x-checker-data:
          type: git
          tag-pattern: ^([\d.]+)$
      - type: archive
        url: https://github.com/OpenChemistry/molecules/archive/refs/heads/master.zip
        sha256: 8d6153a0b87bf5db01eab5dbb102a3aecd2ae4b160af9f6dfe531d51b4811172
        dest: molecules
        dest-filename: molecules.zip
      - type: archive
        url: https://github.com/OpenChemistry/crystals/archive/refs/heads/master.zip
        sha256: 8c8f18376fb6c3d70008bda713d3f0b2ef34752e8602857dc9e58a70d381d7cb
        dest: crystals
        dest-filename: crystals.zip
      #- type: file
        #url: https://github.com/psavery/genXrdPattern/releases/download/1.0-static/linux64-genXrdPattern
        #sha256: 5e0b8f2b463952fd16a92d70b972e4f88af8f6c00e51126a5bd6e2ab243e2ba7
        #dest: avogadrolibs/${FLATPAK_BUILDER_BUILDDIR}/bin
        #dest-filename: genXrdPattern

  - name: Avogadro2
    subdir: Avogadro2
    buildsystem: cmake
    config-opts:
      - -DENABLE_RPATH:BOOL=ON
      - -DENABLE_TESTING:BOOL=OFF
      - -DBUILD_DOCUMENTATION:BOOL=OFF
      - -DCMAKE_BUILD_TYPE:STRING=Release
    post-install:
      - install -Dm644 avogadro/icons/avogadro2_64.png ${FLATPAK_DEST}/share/icons/hicolor/64x64/apps/${FLATPAK_ID}.png
      - install -Dm644 avogadro/icons/avogadro2_128.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/${FLATPAK_ID}.png
      - install -Dm644 avogadro/icons/avogadro2_256.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png
      - install -Dm644 avogadro/icons/avogadro2_512.png ${FLATPAK_DEST}/share/icons/hicolor/512x512/apps/${FLATPAK_ID}.png
      - desktop-file-edit --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/avogadro2.desktop
      # Remove Education category fix Avogadro2 not appearing in menu entry, no clue why.
      - desktop-file-edit --remove-category=Education ${FLATPAK_DEST}/share/applications/avogadro2.desktop
      - install -Dm644 ${FLATPAK_ID}.metainfo.xml ${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml
    sources:
      - type: archive
        url: https://github.com/OpenChemistry/avogadroapp/archive/refs/tags/1.97.0.tar.gz
        sha256: c4e1a0d54e43c2ae8bbd6b872e46b2f983f45c5aaa981731c681d5325faaec63
        dest: Avogadro2
        x-checker-data:
          type: anitya
          project-id: 221509
          stable-only: true
          url-template: https://github.com/OpenChemistry/avogadroapp/archive/refs/tags/$version.tar.gz
      - type: archive
        url: https://github.com/OpenChemistry/avogadro-i18n/archive/refs/heads/master.zip
        dest: avogadro-i18n
        sha256: 75a72f8ab1ce4bc71e0d1a3006d456c72f905279ee30a02feb65fa4d3aa2e27f
      - type: file
        path: org.openchemistry.Avogadro2.metainfo.xml
        dest: Avogadro2
