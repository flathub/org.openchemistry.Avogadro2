app-id: org.openchemistry.Avogadro2
default-branch: beta
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: "6.7"
command: avogadro2
appdata-license: BSD-3-Clause AND GPL-2.0-only
finish-args:
  - --socket=wayland
  - --socket=fallback-x11  # To support X11
  - --share=ipc  # Bad performance on X11 without
  - --device=dri  # OpenGL rendering
  - --share=network  # For plugin downloads
  #- --filesystem=home  # Not needed, use XDG portal via Qt instead
cleanup:
  - /include
  - /lib/cmake
  #- /share/doc
  - '*.la'
  - '*.a'

modules:
  # Should be able to use this with-DUSE_SYSTEM_GLEW=ON flag to Avo but doesn't work?
  #- shared-modules/glew/glew.json
  # Needed to compile glew apparently
  - shared-modules/glu/glu-9.json

  # Open Babel is broken without patched rapidjson
  - name: rapidjson
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: git
        url: https://github.com/Tencent/rapidjson.git
        # Commit used was simply most recent at the time of writing
        # Would rather use 4d6cb08189cf7336821f04090b612baa2ca6a90d (same commit as openSUSE
        # Tumbleweed) as known to be good, but older commits like that don't seem to compile
        commit: 7c73dd7de7c4f14379b781418c6e947ad464c818

  - name: avogadro2
    buildsystem: cmake-ninja
    builddir: true  # Build outside of source tree, just like other builds
    no-make-install: true  # Superbuild doesn't have `install` command defined
    config-opts:
      # Match GitHub builds as much as possible, which generally means using defaults
      - -DCMAKE_BUILD_TYPEG=Release  # As of writing does nothing on Linux but still
      #- -DUSE_SYSTEM_GLEW=ON
      - -DUSE_VTK=ON
      - -DBUILD_GPL_PLUGINS=ON
      - -DBUILD_MOLEQUEUE=OFF
      - -DQT_VERSION=6
      - -DDOWNLOAD_TO_SOURCE_DIR=ON
    build-options:
      ldflags: -Wl,--copy-dt-needed-entries
    sources:
      # First get the umbrella repo so we can use superbuild strategy
      # Clone but not recursively, only want CMake files and dir structure
      - type: git
        url: https://github.com/OpenChemistry/openchemistry.git
        commit: d31cbd9ea0c0c11a12303455317cf0bc2d215044
        disable-shallow-clone: true
        disable-submodules: true
      ## Alternatively, use simple archive
      #- type: archive
      #  url: https://github.com/matterhorn103/openchemistry/archive/refs/heads/flatpak.zip
      #  sha256: d553a4b94ee92fe8909f7ea948cdaaf1a106a7df56e1bf0c71c81909013505c2

      # Do the equivalent of checking out each in-house module
      # avogadro-i8n
      - type: git
        url: https://github.com/OpenChemistry/avogadro-i18n.git
        commit: 07bee855ee8f34b64caf804e69cc4c0b34112ca3
        dest: avogadro-i8n
      # avogadroapp
      - type: git
        url: https://github.com/OpenChemistry/avogadroapp.git
        commit: 380d860eee6f3b2b2f23e15ebe6a0a600d784d8a
        dest: avogadroapp
      # avogadrodata
      - type: git
        url: https://github.com/OpenChemistry/avogadrodata.git
        commit: 91d966abeb1016b0fe469f2c814e7ddb1f546771
        dest: avogadrodata
      # avogadrogenerators
      - type: git
        url: https://github.com/OpenChemistry/avogenerators.git
        commit: f4e3bd7f63664a6844e732e89598bfed48b2c47e
        dest: avogadrogenerators
      # avogadrolibs
      - type: git
        url: https://github.com/OpenChemistry/avogadrolibs.git
        commit: 460ee5bed522864ef49e6ccf15d662f0e6a39aa2
        dest: avogadrolibs
      # crystals
      - type: git
        url: https://github.com/OpenChemistry/crystals.git
        commit: 28404bd4cceae4c7a688f78b50a59ea819186ccd
        dest: crystals
      # fragments
      - type: git
        url: https://github.com/OpenChemistry/fragments.git
        commit: 3c54a8adfcc5210ed454575f0566d758b5004d63
        dest: fragments
      # molecules
      - type: git
        url: https://github.com/OpenChemistry/molecules.git
        commit: ecfb0c27ce02550ff6014a35fbe6a4483032403d
        dest: molecules

      # Now fetch third-party stuff where the source is expected in `openchemistry/thirdparty`
      # VTK
      - type: archive
        url: https://www.vtk.org/files/release/9.3/VTK-9.3.0.tar.gz
        sha256: fdc7b9295225b34e4fdddc49cd06e66e94260cb00efee456e0f66568c9681be9
        dest: thirdparty/VTK
      
      # Other third-party sources would normally be downloaded by Avogadro build on the fly
      # Flatpaks aren't allowed network access during build so have to download source archives
      # ahead of time to download_dir (which we've indicated using `-DDOWNLOAD_TO_SOURCE_DIR=ON`)
      # Match order in projects.cmake
      # glew
      # (Should be able to use shared module but not picked up for whatever reason)
      - type: file
        url: https://github.com/nigels-com/glew/releases/download/glew-2.2.0/glew-2.2.0.tgz
        sha256: d4fc82893cfb00109578d0a1a2337fb8ca335b3ceccf97b97e5cc7f08e4353e1
        dest: Downloads
      # Eigen3
      - type: file
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.gz
        sha256: 8586084f71f9bde545ee7fa6d00288b264a2b7ac3607b974e54d13e7162c1c72
        dest: Downloads
      # OpenBabel
      - type: file
        url: https://github.com/openbabel/openbabel/archive/32cf131444c1555c749b356dab44fb9fe275271f.tar.gz
        sha256: 7b471015df510b30057b8356f42729a35dfd1f4fa85f205c56bbaf3c64e85071
        dest: Downloads
      # spglib
      - type: file
        url: https://github.com/spglib/spglib/archive/v2.3.1.tar.gz
        sha256: c295dbea7d2fc9e50639aa14331fef277878c35f00ef0766e688bfbb7b17d44c
        dest: Downloads
      # libarchive
      - type: file
        url: https://github.com/libarchive/libarchive/archive/v3.6.2.tar.gz
        sha256: 652b84588488c2ff38db8f666cd7f781163f85bff4449dcb2e16d3c734f96697
        dest: Downloads
      # msgpackc
      - type: file
        url: https://github.com/msgpack/msgpack-c/releases/download/cpp-3.3.0/msgpack-3.3.0.tar.gz
        sha256: 6e114d12a5ddb8cb11f669f83f32246e484a8addd0ce93f274996f1941c1f07b
        dest: Downloads
      # mmtf-cpp
      - type: file
        url: https://github.com/rcsb/mmtf-cpp/archive/refs/tags/v1.1.0.tar.gz
        sha256: 021173bdc1814b1d0541c4426277d39df2b629af53151999b137e015418f76c0
        dest: Downloads
      # libmsym
      - type: file
        url: https://github.com/mcodev31/libmsym/archive/refs/tags/v0.2.3-paper.tar.gz
        sha256: 3741ebe163cf40696570d6b62e4834ca587d43dcac9de713994cc5e2960fb8fd
        dest: Downloads

    post-install:
      # Manually copy contents of prefix dir over into main build dir
      # -a option is recursive should preserve permissions and symlinks
      - cp -a prefix/* -t ${FLATPAK_DEST}/
